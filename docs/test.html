<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    /* 设置地图容器全屏 */
    html, body, #map {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
    }
  </style>
</head>
<body>
  <!-- 引入 Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <!-- 引入 Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- 引入 Leaflet.curve 插件 -->
  <script src="leaflet.curve.js"></script>
  <script src="https://unpkg.com/leaflet-polylinedecorator"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <div id="map"></div>
  <script>
    // 创建地图
    var map = L.map('map').setView([0, 0], 2); // 默认位置设置为(0, 0)，缩放级别为2

    // 加载地图底图
    L.tileLayer('https://tiles.stadiamaps.com/tiles/osm_bright/{z}/{x}/{y}{r}.png?api_key=fe0d5c75-05be-425e-a147-61d7c4162184', {
      attribution: '&copy; <a href="https://stadiamaps.com/">Stadia Maps</a>',
      maxZoom: 20
    }).addTo(map);

    // 读取本地的城市坐标文件
    async function loadCityCoordinates() {
      try {
        const response = await fetch('cities_coordinates.json');
        const cityCoordinates = await response.json();
        return cityCoordinates;
      } catch (error) {
        console.error("无法加载城市坐标文件：", error);
        return {};
      }
    }

    // 定义航线数据（不使用 routes.json）
    const routes = [     
        { from: 'Chengdu, China', to: 'Kuche, China' ,year: 2021},
      { from: 'Kurla, China', to: 'Chengdu, China' ,year: 2021},
      {from: 'Chengdu, China', to: 'Shenzhen, China',year: 2021},
      {from: 'Zhuhai, China', to: 'Chongqing, China',year: 2021},
      {from: 'Chengdu, China', to: 'Wuhan, China', year: 2022},
      {from: 'Wuhan, China', to: 'Chengdu, China', year: 2022},
      {from: 'Chengdu, China', to: 'Shanghai, China', year: 2022},
      {from: 'Hangzhou, China', to: 'Chengdu, China', year: 2022},
      {from: 'Chengdu, China', to: 'Qingdao, China', year: 2022},
      {from: 'Qingdao, China', to: 'Hangzhou, China', year: 2022},
      {from: 'Hangzhou, China', to: 'Chengdu, China', year: 2022},
      {from: 'Chengdu, China', to: 'Shenzhen, China', year: 2022},
      {from: 'Shenzhen, China', to: 'Wuhan, China', year: 2022},
      {from: 'Wuhan, China', to: 'Chengdu, China', year: 2022},
      {from: 'Guiyang, China', to: 'Beijing, China', year: 2022},
      {from: 'Chengdu, China', to: 'Lijiang, China', year: 2023},
      {from: 'Beijing, China', to: 'Guangzhou, China',year: 2023},
      {from: 'Guangzhou, China', to: 'Beijing, China',year: 2023},
      {from: 'Beijing, China', to: 'Chengdu, China',year: 2023},
      {from: 'Chengdu, China', to: 'Beijing, China',year: 2023},
      {from: 'Tianjing, China', to: 'Tokyo, Japan',year: 2023},
      {from: 'Nagoya, Japan', to: 'Hongkong, China',year: 2023},
      {from: 'Shenzhen, China', to: 'Chongqing, China',year: 2023},
      {from: 'Chongqing, China', to: 'Beijing, China',year: 2023},
      {from: 'Beijing, China', to: 'Harbin, China',year: 2023},
      {from: 'Fuzhou, China', to: 'Chengdu, China', year: 2024},
      {from: 'Chengdu, China', to: 'Beijing, China', year: 2024},
      {from: 'Beijing, China', to: 'Carol, Egypt', year: 2024},
      {from: 'Carol, Egypt', to: 'Luxor, Egypt', year: 2024},
      {from: 'Luxor, Egypt', to: 'Carol, Egypt', year: 2024},
      {from: 'Carol, Egypt', to: 'Guangzhou, China', year: 2024},
      {from: 'Guangzhou, China', to: 'Beijing, China', year: 2024},
      {from: 'Beijing, China', to: 'Urumqi, China', year: 2024},
      {from: 'Urumqi, China', to: 'Beijing, China', year: 2024},
      {from: 'Beijing, China', to: 'Shenzhen, China', year: 2024},
      {from: 'Shenzhen, China', to: 'Beijing, China', year: 2024},
      {from: 'Beijing, China', to: 'Chengdu, China', year: 2024},
      {from: 'Chengdu, China', to: 'Beijing, China', year: 2024},
      {from: 'Beijing, China', to: 'New York, USA', year: 2024},
      {from: 'New York, USA', to: 'Cancun, Mexico', year: 2024},
      {from: 'Cancun, Mexico', to: 'New York, USA', year: 2024},
      {from: 'New York, USA', to: 'Beijing, China', year: 2024},
      {from: 'Beijing, China', to: 'Istanbul, Turkey', year: 2024},
      {from: 'Istanbul, Turkey', to: 'New York, USA', year: 2024},
        {from: 'Washinton D.C., USA', to: 'Denver, USA', year: 2024},
        {from: 'Denver, USA', to: 'Pittsburgh, USA', year: 2024},
        {from: 'Pittsburgh, USA', to: 'Miami, USA', year: 2024},
        {from: 'Miami, USA', to: 'Pittsburgh, USA', year: 2024},
        {from: 'Pittsburgh, USA', to: 'San Francisco, USA', year: 2024},
    ];

    // 计算两点之间的距离（单位：千米）
    function calculateDistance(fromCoords, toCoords) {
      const R = 6371; // 地球半径，单位为千米
      const lat1 = fromCoords[0] * Math.PI / 180;
      const lat2 = toCoords[0] * Math.PI / 180;
      const dlat = (toCoords[0] - fromCoords[0]) * Math.PI / 180;
      const dlng = (toCoords[1] - fromCoords[1]) * Math.PI / 180;

      const a = Math.sin(dlat / 2) * Math.sin(dlat / 2) +
                  Math.cos(lat1) * Math.cos(lat2) *
                  Math.sin(dlng / 2) * Math.sin(dlng / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

      return R * c; // 返回距离，单位：千米
    }

    function getOffsetControlPoint(fromCoords, toCoords, offset) {
        // 计算中点
        const midPoint = [(fromCoords[0] + toCoords[0]) * 0.5, (fromCoords[1] + toCoords[1]) * 0.5];

        // 计算起点和终点之间的方向向量
        const dx = toCoords[0] - fromCoords[0];
        const dy = toCoords[1] - fromCoords[1];

        // 计算垂直方向的单位向量 (逆时针旋转90度)
        const length = Math.sqrt(dx * dx + dy * dy); // 向量的长度
        const perpendicularUnitVector = [-dy / length, dx / length]; // 垂直向量

        // 在垂直方向上偏移一定的距离
        const controlPoint = [
            midPoint[0] + perpendicularUnitVector[0] * offset,
            midPoint[1] + perpendicularUnitVector[1] * offset
        ];

        return controlPoint;
    }
// 定义年份范围和颜色渐变的函数
function getRouteColor(year) {
  const maxYear = 2025; // 最大年份
  const minYear = 2020; // 最小年份
  const colorScale = d3.scaleLinear()
    .domain([minYear, maxYear]) // 通过年份映射颜色
    .range(["#3B82F6", "#1E3A8A"]); // 从浅蓝色到深蓝色的渐变

  return colorScale(year);
}


    // 绘制航线，并根据航线长度调整弯曲度
    async function drawRoutes(cityCoordinates) {
      const routeRequests = routes.map(city => {
        const fromCoords = cityCoordinates[city.from];
        const toCoords = cityCoordinates[city.to];

        if (fromCoords && toCoords) {
          // 计算航线的距离
          const distance = calculateDistance(fromCoords, toCoords);
          const offset = Math.min((Math.log(distance) * 0.163) ** 8, 50);
          console.log(`Distance between ${city.from} and ${city.to}: ${distance.toFixed(2)} km`);

        // 获取航线的颜色
          const color = getRouteColor(city.year); // 根据年份生成不同的蓝色

          // 绘制曲线
          L.curve(
            ['M', fromCoords, 'Q', 
            getOffsetControlPoint(fromCoords, toCoords, offset), // 获取偏移后的控制点
            toCoords],
            { color: color, weight: 0.5 + (city.year - 2021) * 0.3 , opacity: 0.6 }
        ).addTo(map);


          // 在起点和终点绘制小点
          L.circleMarker(fromCoords, { color: 'red', weight: 0.2, radius: 2 }).addTo(map);
          L.circleMarker(toCoords, { color: 'red', weight: 0.2, radius: 2  }).addTo(map);
        }
      });

      // 等待所有航线绘制完成
      await Promise.all(routeRequests);
    }

    // 加载城市坐标并绘制航线
    loadCityCoordinates().then(cityCoordinates => {
      drawRoutes(cityCoordinates);
    });

  </script>
</body>
</html>

